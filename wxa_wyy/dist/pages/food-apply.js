"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_bind=require("./../mixins/bind.js"),_bind2=_interopRequireDefault(_bind),$Message=require("./../iview/base/index.js").$Message,api=require("./../utils/api.js"),Index=function(e){function t(){var e,o,i,n;_classCallCheck(this,t);for(var a=arguments.length,r=Array(a),s=0;s<a;s++)r[s]=arguments[s];return o=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r))),i.config={navigationBarTitleText:"商品申请",enablePullDownRefresh:!0,backgroundColor:"#efeff4",usingComponents:{"i-input":"../iview/input/index","i-input-number":"../iview/input-number/index","i-button":"../iview/button/index","i-cell-group":"../iview/cell-group/index","i-cell":"../iview/cell/index","i-message":"../iview/message/index"}},i.mixins=[_bind2.default],i.data={validateOk:!1,foodPicture:"",foodId:0,form:{foodName:"",unit:"",price:0,foodPicture:""}},i.watch={form:function(){this.validateOk=this.validate()}},i.methods={selectPicture:function(){var e=this;wx.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){var o=t.tempFilePaths;e.foodPicture=o[0],e.$apply()}})},back:function(){wx.navigateBack({delta:1})},open:function(e){wx.redirectTo({url:e})}},i.events={},n=o,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"validate",value:function(e){return this.data.form.foodName.trim().length<1?(e&&this.showMsg("请填写商品名"),!1):this.data.foodPicture.length<1?(e&&this.showMsg("请上传图片"),!1):this.data.form.unit.length<1?(e&&this.showMsg("请填写商品规格"),!1):!(this.data.form.price<=0)||(e&&this.showMsg("商品报价输入不正确"),!1)}},{key:"showMsg",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"error";$Message({content:e,type:t,duration:3})}},{key:"applyFood",value:function(){var e=this,t=this;if(this.validate(!0)){if(!this.foodPicture)return void this.doApply();wx.showLoading(),api.aliyun.sts.acs({filename:t.foodPicture.substring(t.foodPicture.lastIndexOf("/"))}).done(function(e){wx.uploadFile({url:e.data.uploadUrl,filePath:t.foodPicture,name:"file",formData:e.data.formData,success:function(o){t.form.foodPicture=e.data.objectUrl,t.doApply()}})}).fail(function(){wx.hideLoading(),e.showMsg("文件上传失败")})}}},{key:"doApply",value:function(){api.storeFoodApplication.apply(this.form).done(function(e){wx.showModal({title:"提示",content:"商品申请已经提交，客服会即时审核，请等待！",success:function(e){wx.navigateBack()}})}).always(function(){wx.hideLoading()})}},{key:"onPullDownRefresh",value:function(){}},{key:"onLoad",value:function(e){var t=this;e.foodName&&(this.form.foodName=e.foodName),e.foodId&&(this.foodId=e.foodId,api.page.storeFoodApplicationApply({foodId:e.foodId}).done(function(e){var o=e.data;t.form.foodPicture=o.foodPicture,t.form.foodName=o.foodName,t.form.price=o.foodPrice,t.$apply()}))}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/food-apply"));