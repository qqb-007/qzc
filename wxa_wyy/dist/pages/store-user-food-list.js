"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var a=t[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,o,a){return o&&e(t.prototype,o),a&&e(t,a),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Deferred=require("./../utils/deferred.js"),api=require("./../utils/api.js"),plugin=requirePlugin("WechatSI"),manager=plugin.getRecordRecognitionManager(),DEFAULT_SEARCH_PARAM={page:1,foodCategoryName:"",foodCategoryChildName:""},changeTimeout=0,Index=function(e){function t(){var e,o,a,r;_classCallCheck(this,t);for(var i=arguments.length,n=Array(i),s=0;s<i;s++)n[s]=arguments[s];return o=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n))),a.config={navigationBarTitleText:"商品管理",enablePullDownRefresh:!0,backgroundTextStyle:"dark",backgroundColor:"#efeff4",usingComponents:{"i-input-number":"../iview/input-number/index","i-tag":"../iview/tag/index"}},a.components={},a.data={searchParam:Object.assign({},DEFAULT_SEARCH_PARAM),loading:!1,hasNext:!0,foodCategoryName:"",foodCategoryChildName:"",sufList:[],foodCategoryList:[],keyword:"",changePrice:0,saleList:["全部","已上架","未上架"],saleIndex:1,saleShow:"全部",recording:!1,recordStatus:0,searchFoodName:"",foodCategoryChildrenMap:{}},a.watch={},a.methods={streamRecord:function(e){manager.start(),this.recording=!0,this.setData({recordStatus:0})},end:function(){if(!this.recording||0!==this.recordStatus)return void console.warn("has finished!");this.recording=!1,manager.stop()},confirmb:function(e){var t=this,o=e.currentTarget.dataset,a=o.idx,r=this.sufList[a];r.$lastAlterQuotePrice=r.alterQuotePrice,r.alterQuotePrice=this.changePrice,r.alterQuotePriceShow=r.alterQuotePrice.toFixed(1),changeTimeout&&clearTimeout(changeTimeout),changeTimeout=setTimeout(function(){api.storeUserFood.changeAlterQuotePrice({id:r.food.id,alterQuotePrice:r.alterQuotePrice}).done(function(e){Object.assign(r,e.data),t.$apply()})},500),r.hideModel=!0},getChange:function(e){this.changePrice=parseFloat(e.detail.value)},back:function(){wx.navigateBack({delta:1})},quotePriceChange:function(e){var t=this,o=e.currentTarget.dataset,a=o.idx,r=this.sufList[a];r.$lastAlterQuotePrice=r.alterQuotePrice,r.alterQuotePrice=parseFloat(e.detail.value),r.alterQuotePriceShow=r.alterQuotePrice.toFixed(1),changeTimeout&&clearTimeout(changeTimeout),changeTimeout=setTimeout(function(){api.storeUserFood.changeAlterQuotePrice({id:r.id,alterQuotePrice:r.alterQuotePrice}).done(function(e){Object.assign(r,e.data),t.$apply()})},500)},preview:function(e){wx.previewImage({current:"",urls:[e]})},modalinput:function(e){var t=this.sufList[e];t.hideModel=!t.hideModel,this.changePrice=t.quotePrice},cancel:function(e){this.sufList[e].hideModel=!0},saleChange:function(e){var t=e.detail;this.selectSale(t.value),this.resetSearchParam(),this.loadingSearch()},scrollTop:function(){wx.pageScrollTo({scrollTop:0,duration:300})},searchInputChange:function(e){DEFAULT_SEARCH_PARAM.foodName=e.detail.value,DEFAULT_SEARCH_PARAM.foodCategoryName="",DEFAULT_SEARCH_PARAM.foodCategoryChildName="",this.resetSearchParam(),this.loadingSearch()},selectCategory:function(e){var t=this;DEFAULT_SEARCH_PARAM.foodCategoryName=e,DEFAULT_SEARCH_PARAM.foodCategoryChildName=null,this.loadFoodCategoryChildren(e).then(function(e){e.length?t.doSelectCategoryChild(e[0].name):(t.selectSale(0),t.resetSearchParam(),t.loadingSearch())})},selectCategoryChild:function(e){DEFAULT_SEARCH_PARAM.foodCategoryChildName=DEFAULT_SEARCH_PARAM.foodCategoryChildName===e?null:e,this.selectSale(0),this.resetSearchParam(),this.loadingSearch()},open:function(e){wx.navigateTo({url:e})},soldOut:function(e){var t=this.sufList[e],o=this;wx.showModal({title:"提示",content:"确认下架该商品吗？",success:function(e){e.confirm?api.storeUserFood.soldOut({foodId:t.food.id}).done(function(e){e.data&&(t.sale=!1,wx.showToast({title:"下架成功",icon:"success",duration:500}),o.$apply())}):e.cancel}})},addSku:function(e){var t=this.sufList[e];wx.navigateTo({url:"/pages/food-apply?foodId="+t.food.id})},publishSku:function(e){var t=this.sufList[e];wx.navigateTo({url:"/pages/store-user-food-sku?id="+t.id})},sale:function(e){var t=this.sufList[e],o=this;wx.showModal({title:"提示",content:"确认上架该商品吗？",success:function(e){e.confirm?api.storeUserFood.sale({foodId:t.food.id}).done(function(e){e.data&&(t.sale=!0,wx.showToast({title:"上架成功",icon:"success",duration:500}),o.$apply())}):e.cancel}})}},a.events={},r=o,_possibleConstructorReturn(a,r)}return _inherits(t,e),_createClass(t,[{key:"showRecordEmptyTip",value:function(){this.setData({recording:!1,bottomButtonDisabled:!1}),wx.showToast({title:"请说话",duration:2e3,icon:"success",success:function(e){},fail:function(e){console.log(e)}})}},{key:"getRecordAuth",value:function(){wx.getSetting({success:function(e){console.log("succ"),console.log(e),e.authSetting["scope.record"]?console.log("record has been authed"):wx.authorize({scope:"scope.record",success:function(){console.log("succ auth")},fail:function(){console.log("fail auth")}})},fail:function(e){console.log("fail"),console.log(e)}})}},{key:"resetSearchParam",value:function(){Object.assign(this.searchParam,DEFAULT_SEARCH_PARAM),this.hasNext=!0}},{key:"doSelectCategoryChild",value:function(e){DEFAULT_SEARCH_PARAM.foodCategoryChildName=e,this.selectSale(0),this.resetSearchParam(),this.loadingSearch()}},{key:"loadFoodCategoryChildren",value:function(e){var t=this;return new Promise(function(o){if(t.foodCategoryChildrenMap[e])return void o(t.foodCategoryChildrenMap[e]);api.foodCategory.listByParentName({parentName:e}).done(function(a){t.foodCategoryChildrenMap[e]=a.data,t.$apply(),o(a.data)})})}},{key:"selectSale",value:function(e){switch(this.saleIndex=e,this.saleShow=this.saleList[e],e+""){case"0":DEFAULT_SEARCH_PARAM.sale="";break;case"1":DEFAULT_SEARCH_PARAM.sale=!0;break;case"2":DEFAULT_SEARCH_PARAM.sale=!1}}},{key:"onReachBottom",value:function(){this.hasNext&&(this.searchParam.page++,this.search(!0))}},{key:"onPullDownRefresh",value:function(){this.resetSearchParam(),this.loadData(),this.search().always(function(){wx.stopPullDownRefresh()})}},{key:"loadingSearch",value:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){wx.showLoading(),t.search(e).always(function(){wx.hideLoading(),t.searchParam.page&&1!==t.searchParam.page||wx.pageScrollTo({scrollTop:0,duration:300})})},500)}},{key:"search",value:function(e,t){var o=this,a=_extends({},this.searchParam,{foodCategoryName:this.searchParam.foodCategoryChildName||this.searchParam.foodCategoryName});return console.info(a),api.storeUserFood.search(a).done(function(t){t.data.results.forEach(function(e){e.quotePriceShow=e.quotePrice.toFixed(1),e.hideModel=!0,e.alterQuotePrice=e.alterQuotePrice||e.quotePrice,e.alterQuotePriceShow=e.alterQuotePrice.toFixed(1)}),o.sufList=e?o.sufList.concat(t.data.results):t.data.results;var a=t.data;o.hasNext=a.hasNext,o.$apply()}).always(function(){t&&t()})}},{key:"loadData",value:function(){var e=this;return api.page.storeUserFoodList().done(function(t){e.foodCategoryList=t.data.foodCategoryList,e.$apply()})}},{key:"onLoad",value:function(){var e=this;this.getRecordAuth(),manager.onStop=function(t){var o=t.result.replace("。","");if(""===o)return void e.showRecordEmptyTip();console.log(o),e.$emit("getText",o),e.searchFoodName=o,DEFAULT_SEARCH_PARAM.foodName=o,DEFAULT_SEARCH_PARAM.foodCategoryName="",DEFAULT_SEARCH_PARAM.foodCategoryChildName="",e.resetSearchParam(),e.loadingSearch()},this.selectSale(0),Deferred.when(this.loadData(),this.search()).always(function(){e.loaded=!0})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/store-user-food-list"));