"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Deferred=require("./../utils/deferred.js"),api=require("./../utils/api.js"),DEFAULT_SEARCH_PARAM={page:1,pageSize:5},Index=function(e){function t(){var e,a,n,r;_classCallCheck(this,t);for(var i=arguments.length,o=Array(i),s=0;s<i;s++)o[s]=arguments[s];return a=n=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o))),n.config={navigationBarTitleText:"历史账单",enablePullDownRefresh:!0,backgroundTextStyle:"dark",usingComponents:{"i-tag":"../iview/tag/index","i-divider":"../iview/divider/index"}},n.components={},n.data={searchParam:Object.assign({},DEFAULT_SEARCH_PARAM),loading:!1,hasNext:!0,sheetList:[],weekSheetDetailList:[]},n.methods={showDetail:function(e){wx.navigateTo({url:"food-quote-sheet-detail?foodQuoteSheetId="+e})}},n.events={},r=a,_possibleConstructorReturn(n,r)}return _inherits(t,e),_createClass(t,[{key:"computed",value:function(){}},{key:"resetSearchParam",value:function(){Object.assign(this.searchParam,DEFAULT_SEARCH_PARAM),this.hasNext=!0}},{key:"onPullDownRefresh",value:function(){this.resetSearchParam(),this.loadData().always(function(){wx.stopPullDownRefresh()})}},{key:"onReachBottom",value:function(){this.hasNext&&(this.searchParam.page++,this.search(!0))}},{key:"search",value:function(e,t){var a=this;return wx.showLoading({title:"加载中"}),api.settlementSheet.search(this.searchParam).done(function(t){a.handleSheetList(t.data.results),a.sheetList=e?a.sheetList.concat(t.data.results):t.data.results;var n=t.data;a.hasNext=n.hasNext,a.$apply()}).always(function(){wx.hideLoading(),t&&t()})}},{key:"handleSheetList",value:function(e){var t=this;e.forEach(function(e){e.settlementAmountStr=e.settlementAmount.toFixed(1),e.date=e.startDate.replace(/-/g,".")+" - "+e.endDate.replace(/-/g,".").substring(5),e.detailList.sort(function(e,t){return t.date.localeCompare(e.date)}),t.handleDetailList(e.detailList)})}},{key:"onLoad",value:function(){this.loadData()}},{key:"handleDetailList",value:function(e){e.forEach(function(e){e.settlementAmountStr=e.settlementAmount.toFixed(1),e.deductAmountStr=e.deductAmount.toFixed(1),e.orderAmountStr=e.orderAmount.toFixed(1),e.partRefundAmountStr=e.partRefundAmount.toFixed(1)})}},{key:"loadPage",value:function(){var e=this;return api.page.settlementSheetList().done(function(t){e.weekSheetDetailList=t.data.weekSettlementSheetDetailList,e.handleDetailList(e.weekSheetDetailList),e.$apply()})}},{key:"loadData",value:function(){var e=this;return Deferred.when(this.loadPage(),this.search()).always(function(){e.loaded=!0})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/settlement-sheet-list"));