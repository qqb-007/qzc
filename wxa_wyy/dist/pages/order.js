"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Deferred=require("./../utils/deferred.js"),api=require("./../utils/api.js"),color=require("./../utils/color.js"),time=require("./../utils/time.js"),caution=require("./../utils/caution.js"),DEFAULT_SEARCH_PARAM={page:1,daySeq:"",statusType:"",date:""},FOOD_DEFAULT_SEARCH_PARAM={page:1},Index=function(t){function e(){var t,a,i,s;_classCallCheck(this,e);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return a=i=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(n))),i.config={navigationBarTitleText:"订单",enablePullDownRefresh:!0,backgroundTextStyle:"dark",usingComponents:{"i-tabs":"../iview/menus/index","i-tab":"../iview/menu/index","i-tag":"../iview/tag/index","i-divider":"../iview/divider/index","i-input":"../iview/input/index"}},i.components={},i.data={searchParam:Object.assign({},DEFAULT_SEARCH_PARAM),foodSearchParam:Object.assign({},FOOD_DEFAULT_SEARCH_PARAM),loading:!1,hasNext:!0,empty:!1,orderList:[],platOrderId:"",dateShow:"--",statusList:["全部订单","已完成","预订单"],statusType:["ALL","FINISHED","RESERVE"],statusListIndex:0,statusShow:"全部订单",platList:["全部平台","美团","饿了么","京东"],platType:["","MEITUAN","ELE","JDDJ"],platListIndex:0,orderStatusIndex:0,platShow:"所有平台",hideModel:!0,detail:{foodId:"",price:"",foodUnit:""}},i.methods={open:function(t){wx.navigateTo({url:t})},tellPhone:function(t){wx.makePhoneCall({phoneNumber:t.replace("_",",")+""})},showDetail:function(t){var e=this.orderList[t];e.detailShown=!e.detailShown,e.detailList||this.loadDetailList(e),this.$apply()},soldOut:function(t){var e=this;wx.showModal({title:"提示",content:"确认下架该商品吗？",success:function(a){a.confirm?api.storeUserFood.soldOut({foodId:t}).done(function(t){t.data&&(wx.showToast({title:"下架成功",icon:"success",duration:500}),e.$apply())}):a.cancel}})},StatusTypeChange:function(t){var e=t.detail;this.orderStatusIndex=e.key,this.statusListIndex=e.key,this.statusShow=this.statusList[this.statusListIndex],this.searchParam.statusType=this.statusType[this.statusListIndex],this.loadingSearch()},back:function(){wx.navigateBack({delta:1})},copyClipboard:function(t){wx.setClipboardData({data:t+"",success:function(){wx.showToast({title:"复制成功",icon:"success",duration:500})}})},preview:function(t){wx.previewImage({current:"",urls:[t]})},modalinput:function(t){var e=this,a=t;this.detail.foodId=a.foodCode,this.detail.foodUnit=a.unit,FOOD_DEFAULT_SEARCH_PARAM.foodId=a.foodCode,this.resetFoodSearchParam(),api.storeUserFood.search(this.foodSearchParam).done(function(t){var a=t.data.results[0];e.detail.price=a.alterQuotePrice,e.$apply()}),this.hideModel=!1},getChange:function(t){this.detail.price=t.detail.value},confirmb:function(){if(""===this.detail.price||"."===this.detail.price)return void wx.showToast({title:"输入错误,请重新输入！",icon:"none",duration:1500});var t=this.detail.price,e=this.detail.foodId;wx.showModal({title:"提示",content:"当前报价为 "+this.detail.price+"元/"+this.detail.foodUnit+"的价格，确定改价吗",success:function(a){a.confirm?(api.storeUserFood.changeAlterQuotePrice({id:e,alterQuotePrice:t}).always(function(){wx.showToast({title:"改价完成 审核后生效！",icon:"none",duration:1500})}),console.log(t+"  "+e)):a.cancel&&console.log("用户点击了取消")}}),this.hideModel=!0,this.detail.price="",this.$apply()},cancel:function(){this.hideModel=!0,this.detail.price="",this.$apply()},statusChange:function(t){var e=t.detail;this.statusListIndex=e.value,this.orderStatusIndex=e.value,this.statusShow=this.statusList[this.statusListIndex],this.searchParam.statusType=this.statusType[this.statusListIndex],this.loadingSearch()},platChange:function(t){var e=t.detail;this.platListIndex=e.value,this.platShow=this.platList[this.platListIndex],this.searchParam.plat=this.platType[this.platListIndex],this.loadingSearch()},dateChange:function(t){var e=t.detail;this.searchParam.date=e.value;var a=new Date(Date.parse(this.searchParam.date));this.dateShow=a.getMonth()+1+"."+a.getDate(),this.loadingSearch()},searchInputChange:function(t){var e=t.detail;this.searchParam.daySeq=e.value,this.loadingSearch()},receiptOrder:function(t){var e=this;wx.showLoading(),api.order.receipt({id:t}).done(function(t){t.data?wx.showToast({title:"接单成功",icon:"success",duration:500}):wx.showToast({title:"接单失败",duration:500})}).always(function(){wx.hideLoading(),e.search()})},print:function(t){wx.showLoading(),api.order.print({id:t}).done(function(t){t.data?wx.showToast({title:"打印成功",icon:"success",duration:500}):wx.showToast({title:"打印失败",duration:500})}).always(function(){wx.hideLoading()})},sendDelivery:function(t){var e=this;wx.showModal({title:"提示",content:"确认发起配送吗",success:function(a){a.confirm?(wx.showLoading(),api.order.sendDelivery({id:t}).done(function(t){t.data?wx.showToast({title:"发起配送成功",icon:"success",duration:500}):wx.showToast({title:"发起配送失败",duration:500})}).always(function(){wx.hideLoading(),e.search()})):console.log("用户点击取消")}})},cancelDelivery:function(t){var e=this;wx.showModal({title:"提示",content:"确认取消配送吗？",success:function(a){a.confirm?(wx.showLoading(),api.order.cancelDelivery({id:t}).done(function(t){t.data?wx.showToast({title:"取消配送成功",icon:"success",duration:500}):wx.showToast({title:"取消配送失败",duration:500})}).always(function(){wx.hideLoading(),e.search()})):console.log("用户点击取消")}})}},i.events={},s=a,_possibleConstructorReturn(i,s)}return _inherits(e,t),_createClass(e,[{key:"computed",value:function(){}},{key:"resetSearchParam",value:function(){Object.assign(this.searchParam,DEFAULT_SEARCH_PARAM),this.hasNext=!0}},{key:"resetFoodSearchParam",value:function(){Object.assign(this.foodSearchParam,FOOD_DEFAULT_SEARCH_PARAM)}},{key:"loadingSearch",value:function(){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){wx.showLoading(),t.page=1,t.search().always(function(){wx.hideLoading()})},500)}},{key:"onPullDownRefresh",value:function(){this.search().always(function(){wx.stopPullDownRefresh()})}},{key:"loadDetailList",value:function(t){var e=this;return wx.showLoading(),api.order.detailList({id:t.id}).done(function(a){a.data.forEach(function(t){t._total=(t.costTotal-t.costRefund).toFixed(2)}),t.detailList=a.data,e.$apply()}).always(function(){wx.hideLoading()})}},{key:"onReachBottom",value:function(){this.hasNext&&(this.searchParam.page++,this.search(!0))}},{key:"search",value:function(t,e){var a=this;return wx.showLoading({title:"加载中"}),api.order.search(this.searchParam).done(function(e){a.handleOrderList(e.data.results),a.orderList=t?a.orderList.concat(e.data.results):e.data.results;var i=e.data;a.hasNext=i.hasNext,a.empty=1===a.searchParam.page&&0===a.orderList.length,a.$apply()}).always(function(){wx.hideLoading(),e&&e()})}},{key:"handleOrderList",value:function(t){var e=this;t.forEach(function(t){"WAIT_MERCHANT_CONFIRM"===t.status&&(console.log("进行自动接单 "+t.id),api.order.receipt({id:t.id}).done(function(e){e.data?(console.log("接单成功"),t.status="MERCHANT_CONFIRMED",t.statusTitle="已接单"):console.log("接单失败")})),t.statusColor=e.getStatusStyle(t.status),t.detailShown=!0,e.loadDetailList(t),t.ptime=time.judgeTime(t.expectedDeliveryTime),t.deliveryTime=time.formatTime(t.expectedDeliveryTime,"M/D h:m"),t.publishStatusColor=e.getPublishStatusStyle(t.publishStatus),t._total=(t.costTotal-t.costRefund).toFixed(2),t.caution=caution.filter(t.caution)})}},{key:"getStatusStyle",value:function(t){switch(t){case"PAID":return color.warning;case"VERIFY_SUCCESS":return color.success;case"VERIFY_FAIL":return color.danger}}},{key:"getPublishStatusStyle",value:function(t){switch(t){case"WAIT":return"yellow";case"WAIT_MERCHANT_CONFIRM":return"green";case"MERCHANT_CONFIRMED":case"CANCELED":case"SHIPPING":return"red"}}},{key:"onLoad",value:function(){var t=this,e=new Date;this.dateShow=e.getMonth()+1+"."+e.getDate(),Deferred.when(this.search()).always(function(){t.loaded=!0})}}]),e}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/order"));