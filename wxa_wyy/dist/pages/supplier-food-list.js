"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(e[o]=a[o])}return e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var o=t[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,a,o){return a&&e(t.prototype,a),o&&e(t,o),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Deferred=require("./../utils/deferred.js"),api=require("./../utils/api.js"),DEFAULT_SEARCH_PARAM={page:1,foodCategoryName:""},changeTimeout=0,Index=function(e){function t(){var e,a,o,r;_classCallCheck(this,t);for(var i=arguments.length,s=Array(i),n=0;n<i;n++)s[n]=arguments[n];return a=o=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),o.config={navigationBarTitleText:"供应商商品",enablePullDownRefresh:!0,backgroundTextStyle:"dark",backgroundColor:"#efeff4",usingComponents:{"i-input-number":"../iview/input-number/index","i-tag":"../iview/tag/index"}},o.components={},o.data={searchParam:Object.assign({},DEFAULT_SEARCH_PARAM),loading:!1,hasNext:!0,sufList:[],foodSupplierId:0,foodCategoryList:[],keyword:"",saleList:["全部","已上架","未上架"],saleIndex:1,saleShow:"全部"},o.methods={quotePriceChange:function(e){var t=this,a=e.currentTarget.dataset,o=a.idx,r=this.sufList[o];r.$lastAlterQuotePrice=r.alterQuotePrice,r.alterQuotePrice=parseFloat(e.detail.value),r.alterQuotePriceShow=r.alterQuotePrice.toFixed(1),changeTimeout&&clearTimeout(changeTimeout),changeTimeout=setTimeout(function(){api.storeUserFood.changeAlterQuotePrice({id:r.id,alterQuotePrice:r.alterQuotePrice}).done(function(e){Object.assign(r,e.data),t.$apply()})},500)},preview:function(e){wx.previewImage({current:"",urls:[e]})},saleChange:function(e){var t=e.detail;this.selectSale(t.value),this.resetSearchParam(),this.loadingSearch()},scrollTop:function(){wx.pageScrollTo({scrollTop:0,duration:300})},searchInputChange:function(e){DEFAULT_SEARCH_PARAM.foodName=e.detail.value,this.resetSearchParam(),this.loadingSearch()},selectCategory:function(e){DEFAULT_SEARCH_PARAM.foodCategoryName=e,this.selectSale(0),this.resetSearchParam(),this.loadingSearch()},open:function(e){wx.navigateTo({url:e})},soldOut:function(e){var t=this.sufList[e],a=this;wx.showModal({title:"提示",content:"确认下架该商品吗？",success:function(e){e.confirm?api.storeUserFood.soldOut({foodId:t.food.id}).done(function(e){e.data&&(t.sale=!1,wx.showToast({title:"下架成功",icon:"success",duration:500}),a.$apply())}):e.cancel}})},addSku:function(e){var t=this.sufList[e];wx.navigateTo({url:"/pages/food-apply?foodId="+t.food.id})},publishSku:function(e){var t=this.sufList[e];wx.navigateTo({url:"/pages/store-user-food-sku?id="+t.id})},sale:function(e){var t=this.sufList[e],a=this;wx.showModal({title:"提示",content:"确认上架该商品吗？",success:function(e){e.confirm?api.storeUserFood.sale({foodId:t.food.id}).done(function(e){e.data&&(t.sale=!0,wx.showToast({title:"上架成功",icon:"success",duration:500}),a.$apply())}):e.cancel}})}},o.events={},r=a,_possibleConstructorReturn(o,r)}return _inherits(t,e),_createClass(t,[{key:"resetSearchParam",value:function(){Object.assign(this.searchParam,DEFAULT_SEARCH_PARAM),this.hasNext=!0}},{key:"selectSale",value:function(e){switch(this.saleIndex=e,this.saleShow=this.saleList[e],e+""){case"0":DEFAULT_SEARCH_PARAM.sale="";break;case"1":DEFAULT_SEARCH_PARAM.sale=!0;break;case"2":DEFAULT_SEARCH_PARAM.sale=!1}}},{key:"onReachBottom",value:function(){this.hasNext&&(this.searchParam.page++,this.search(!0))}},{key:"onPullDownRefresh",value:function(){this.resetSearchParam(),this.loadData(),this.search().always(function(){wx.stopPullDownRefresh()})}},{key:"loadingSearch",value:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){wx.showLoading(),t.search(e).always(function(){wx.hideLoading()})},500)}},{key:"search",value:function(e,t){var a=this;return api.storeUserFood.search(_extends({},this.searchParam,{foodSupplierId:this.foodSupplierId})).done(function(t){t.data.results.forEach(function(e){e.quotePriceShow=e.quotePrice.toFixed(1),e.alterQuotePrice=e.alterQuotePrice||e.quotePrice,e.alterQuotePriceShow=e.alterQuotePrice.toFixed(1)}),a.sufList=e?a.sufList.concat(t.data.results):t.data.results;var o=t.data;a.hasNext=o.hasNext,a.$apply()}).always(function(){t&&t()})}},{key:"loadData",value:function(){var e=this;return api.page.supplierFoodList({foodSupplierId:this.foodSupplierId}).done(function(t){e.foodCategoryList=t.data.foodCategoryList,e.$apply()})}},{key:"onLoad",value:function(e){var t=this;this.foodSupplierId=+e.foodSupplierId,this.selectSale(1),Deferred.when(this.loadData(),this.search()).always(function(){t.loaded=!0})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/supplier-food-list"));