"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Deferred=require("./../utils/deferred.js"),api=require("./../utils/api.js"),DEFAULT_SEARCH_PARAM={page:1,categoryName:""},Index=function(e){function t(){var e,o,i,a;_classCallCheck(this,t);for(var s=arguments.length,n=Array(s),r=0;r<s;r++)n[r]=arguments[r];return o=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n))),i.config={navigationBarTitleText:"商品管理",enablePullDownRefresh:!0,backgroundTextStyle:"dark",backgroundColor:"#efeff4",usingComponents:{"i-input-number":"../iview/input-number/index","i-switch":"../iview/switch/index","i-tag":"../iview/tag/index","i-checkbox":"../iview/checkbox/index"}},i.components={},i.data={searchParam:Object.assign({},DEFAULT_SEARCH_PARAM),loading:!1,hasNext:!0,foodList:[],quotedFoodList:[],foodCategoryList:[],showQuoted:!1,keyword:""},i.methods={quotePriceChange:function(e){var t=e.currentTarget.dataset,o=t.idx,i=this.foodList[o];i.quotePrice=e.detail.value,i.checked=!0,this.quoteFood(i),this.handleFoodShow()},scrollTop:function(){wx.pageScrollTo({scrollTop:0,duration:300})},searchInputChange:function(e){DEFAULT_SEARCH_PARAM.foodName=e.detail.value,this.resetSearchParam(),this.loadingSearch()},selectCategory:function(e){DEFAULT_SEARCH_PARAM.categoryName=e,this.resetSearchParam(),this.loadingSearch()},soldOut:function(e){var t=this.foodList[e],o=this;wx.showModal({title:"提示",content:"确认下架该商品吗？",success:function(e){e.confirm?api.storeUserFood.soldOut({foodId:t.foodId}).done(function(e){e.data&&(t.sale=!1,wx.showToast({title:"下架成功",icon:"success",duration:500}),o.$apply())}):e.cancel}})},showQuotedSwitchChange:function(e){var t=e.detail;this.showQuoted=t.value,this.$apply()},toggleSelected:function(e){var t=this.showQuoted?this.quotedFoodList[e]:this.foodList[e];t.checked=!t.checked,t.quotePrice||(t.quotePrice=t.foodPrice),this.quoteFood(t),this.handleFoodShow()},submit:function(){var e=this;wx.showModal({title:"问题提示",content:"提交前，请确认您的报价信息的准确！",confirmText:"确认提交",success:function(t){if(t.confirm){var o=[];e.quotedFoodList.forEach(function(e){o.push({foodId:e.foodId,price:e.quotePrice})}),api.quote.food({json:JSON.stringify({foodQuoteInfoList:o})}).done(function(t){wx.showModal({title:"温馨提示",content:"报价单提交成功，请等待客服审核！",success:function(t){e.clearFoodQuoteList(),e.$apply(),wx.switchTab({url:"/pages/food-quote-sheet"})}})})}else t.cancel}})}},i.events={},a=o,_possibleConstructorReturn(i,a)}return _inherits(t,e),_createClass(t,[{key:"clearFoodQuoteList",value:function(){this.quotedFoodList.forEach(function(e){e.checked=!1}),this.quotedFoodList=[],this.$apply()}},{key:"resetSearchParam",value:function(){Object.assign(this.searchParam,DEFAULT_SEARCH_PARAM),this.hasNext=!0}},{key:"onReachBottom",value:function(){this.hasNext&&(this.searchParam.page++,this.search(!0))}},{key:"onPullDownRefresh",value:function(){this.resetSearchParam(),this.search().always(function(){wx.stopPullDownRefresh()})}},{key:"loadingSearch",value:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){wx.showLoading(),t.search(e).always(function(){wx.hideLoading()})},500)}},{key:"search",value:function(e,t){var o=this;return this.showQuoted?this.searchParam.foodIdList=this.quotedFoodList.map(function(e){return e.foodId}):delete this.searchParam.foodIdList,api.quote.foodSearch(this.searchParam).done(function(t){t.data.results.forEach(function(e){e.foodPrice&&(e.foodPrice=parseFloat(e.foodPrice.toFixed(1)));var t=o.checkQuoted(e);if(-1!==t){var i=o.quotedFoodList[t];e.quotePrice=i.quotePrice,e.checked=!0,o.quotedFoodList[t]=e}}),o.foodList=e?o.foodList.concat(t.data.results):t.data.results;var i=t.data;o.hasNext=i.hasNext,o.$apply()}).always(function(){t&&t()})}},{key:"quoteFood",value:function(e){if(e.checked)-1===this.checkQuoted(e)&&this.quotedFoodList.push(e);else for(var t=0;t<this.quotedFoodList.length;t++)e.foodId===this.quotedFoodList[t].foodId&&this.quotedFoodList.splice(t,1)}},{key:"handleFoodShow",value:function(){var e=this;this.foodList.forEach(function(t){e.keyword?t.hide=-1===t.foodName.indexOf(e.keyword):e.showQuoted?t.hide=!t.checked:t.hide=!1}),this.$apply()}},{key:"checkQuoted",value:function(e){for(var t=0;t<this.quotedFoodList.length;t++)if(e.foodId===this.quotedFoodList[t].foodId)return t;return-1}},{key:"loadData",value:function(){var e=this;return api.page.quote().done(function(t){e.foodCategoryList=t.data.foodCategoryList,e.$apply()})}},{key:"onLoad",value:function(){var e=this;Deferred.when(this.loadData(),this.search()).always(function(){e.loaded=!0})}}]),t}(_wepy2.default.page);exports.default=Index;