"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var o=t[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,a,o){return a&&e(t.prototype,a),o&&e(t,o),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Deferred=require("./../utils/deferred.js"),api=require("./../utils/api.js"),DEFAULT_SEARCH_PARAM={page:1,categoryName:""},Index=function(e){function t(){var e,a,o,r;_classCallCheck(this,t);for(var n=arguments.length,i=Array(n),s=0;s<n;s++)i[s]=arguments[s];return a=o=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),o.config={navigationBarTitleText:"商品管理",enablePullDownRefresh:!0,backgroundTextStyle:"dark",backgroundColor:"#efeff4",usingComponents:{"i-input-number":"../iview/input-number/index","i-button":"../iview/button/index"}},o.components={},o.data={searchParam:Object.assign({},DEFAULT_SEARCH_PARAM),loading:!1,hasNext:!0,hideModel:!1,foodList:[],foodCategoryList:[],keyword:""},o.methods={priceChange:function(e){var t=e.currentTarget.dataset,a=t.idx,o=this.foodList[a];o.price=parseFloat(e.detail.value),o.priceShow=o.price.toFixed(1)},addNew:function(){wx.navigateTo({url:"/pages/food-apply?foodName="+DEFAULT_SEARCH_PARAM.name})},scrollTop:function(){wx.pageScrollTo({scrollTop:0,duration:300})},preview:function(e){wx.previewImage({current:"",urls:[e]})},back:function(){wx.navigateBack({delta:1})},searchInputChange:function(e){DEFAULT_SEARCH_PARAM.name=e.detail.value},searchBtnChange:function(e){this.resetSearchParam(),this.loadingSearch()},cancel:function(){this.hideModel=!0},confirmb:function(){this.hideModel=!0,this.resetSearchParam(),this.loadingSearch()},selectCategory:function(e){DEFAULT_SEARCH_PARAM.categoryName=e,this.resetSearchParam(),this.loadingSearch()},add:function(e){var t=this,a=this.foodList[e];wx.showLoading(),api.storeUserFood.save({foodId:a.id,quotePrice:a.price,sale:!1}).done(function(e){a.added=!0,t.$apply()}).always(function(){wx.hideLoading()})}},o.events={},r=a,_possibleConstructorReturn(o,r)}return _inherits(t,e),_createClass(t,[{key:"resetSearchParam",value:function(){Object.assign(this.searchParam,DEFAULT_SEARCH_PARAM),this.hasNext=!0}},{key:"onReachBottom",value:function(){this.hasNext&&(this.searchParam.page++,this.search(!0))}},{key:"onPullDownRefresh",value:function(){this.resetSearchParam(),this.search().always(function(){wx.stopPullDownRefresh()})}},{key:"loadingSearch",value:function(e){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(function(){wx.showLoading(),t.search(e).always(function(){wx.hideLoading()})},500)}},{key:"search",value:function(e,t){var a=this;return api.food.search(this.searchParam).done(function(t){t.data.results.forEach(function(e){e.priceShow=e.price.toFixed(1)}),a.foodList=e?a.foodList.concat(t.data.results):t.data.results,0===a.foodList.length&&wx.redirectTo({url:"/pages/food-apply?foodName="+DEFAULT_SEARCH_PARAM.name});var o=t.data;a.hasNext=o.hasNext,a.$apply()}).always(function(){t&&t()})}},{key:"loadData",value:function(){var e=this;return api.page.storeUserFoodList().done(function(t){e.foodCategoryList=t.data.foodCategoryList,e.$apply()})}},{key:"onLoad",value:function(){var e=this;this.hideModel=!1,Deferred.when(this.loadData(),this.search()).always(function(){e.loaded=!0})}},{key:"onShow",value:function(){}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/food-list"));