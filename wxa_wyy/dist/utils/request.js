"use strict";var extend=require("./extend.js"),urlPath=require("./url-path.js"),Deferred=require("./deferred.js"),serialize=require("./serialize.js"),login=require("./login.js"),loginDoing=!1,loginOptions=[],cookie=require("./cookie.js"),API={request:function(e){e=extend({},e||{}),e.header=e.header||{},e.header["Content-Type"]||(e.header["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),e.header.Cookie=cookie.cookie();var n=new Deferred;return n.fail(function(e,n){n.errMsg&&wx.showModal({title:"信息提示",content:n.errMsg.split(" ")[1],success:function(){}})}),e.success=function(t){var o=arguments,i=t.data;if(void 0===t||void 0===i)return void n.reject(i,t);if(i.success)n.resolve(t.data,t);else{if(403===i.statusCode){if(loginDoing)return void loginOptions.push(e);loginOptions.push(e),loginDoing=!0,login.invalidate().done(function(){login.login(function(){for(loginDoing=!1;loginOptions.length;)API.request(loginOptions.pop()).done(function(){n.resolve.apply(n,Array.prototype.slice.call(arguments))}).fail(function(e){n.reject.apply(n,Array.prototype.slice.call(o))})})})}"SYSTEM"===i.level&&(wx.showModal({title:"信息提示",content:i.errMsg,success:function(e){}}),n.reject(t.data,t))}},e.fail=function(e){wx.showModal({title:"信息提示",content:e.errMsg.split(" ")[1],success:function(e){}}),n.reject(e.data,e)},e.complete=function(e){if(e.header){var n=e.header["Set-Cookie"];n&&cookie.setCookies(n)}},wx.request(e),n},do_request:function(e,n,t,o){if("function"==typeof e){var i=e(n);"string"==typeof i?e=i:(e=i[0],i.length>1&&(n=i[1]))}return e=urlPath.api(e),e=e.replace(/\{([^}]+)}/gi,function(e,t){var o=n[t];return delete n[t],o}),"get"===t.toLowerCase()&&(-1===e.indexOf("?")?e+="?_t="+(new Date).getTime():e+="&_t="+(new Date).getTime(),e=e+"&"+("string"!=typeof n?serialize(n):void 0===n?"":n),n=""),this.request({url:e,type:o,data:n,method:t})},createFunction:function(e,n){var t=this;return function(o,i,r){return r&&r.onRequest&&r.onRequest(),t.do_request(e,o,n||"GET",i||"json").done(function(e){r&&r.onSuccess&&r.onSuccess(e)}).fail(function(e){r&&r.onFail&&r.onFail(e)}).always(function(e){r&&r.onFinish&&r.onFinish(e)})}},createUrl:function(e){return e=urlPath.api(e),function(n){return e.replace(/\{([^}]+)}/gi,function(e,t){var o="string"==typeof n?n:n[t];return void 0===o?"":o})}}};module.exports=API;